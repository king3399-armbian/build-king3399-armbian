name: build-armbian-king3399

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout build repo
        uses: actions/checkout@v4
        with:
          repository: king3399-armbian/build-king3399-armbian
          ref: king3399-build
          fetch-depth: 1

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential gcc g++ make \
            bc bison flex libssl-dev libncurses5-dev \
            python3 python3-dev python3-pip \
            qemu-user-static debootstrap device-tree-compiler

      - name: Build king3399
        run: |
          ./compile.sh \
            BOARD=king3399 \
            BRANCH=vendor \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=no \
            KERNEL_CONFIGURE=no \
            RELEASE=jammy

      - name: Prepare release tag
        id: tag
        run: |
          TAG=king3399-$(date +%Y%m%d-%H%M)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: |
            Armbian build for king3399

            If you disable Bluetooth and need to re-enable it, run: systemctl restart rk3399-bluetooth.service
            如果你关闭蓝牙后需要再次启动，你需要执行：systemctl restart rk3399-bluetooth.service
          files: output/images/*
